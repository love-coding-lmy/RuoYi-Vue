<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.shop.mapper.ShopOrderMapper">

    <resultMap type="ShopOrder" id="ShopOrderResult">
        <id     property="orderId"           column="order_id"          />
        <result property="orderNo"           column="order_no"          />
        <result property="userId"            column="user_id"           />
        <result property="username"          column="username"          />
        <result property="orderStatus"       column="order_status"      />
        <result property="productCount"      column="product_count"     />
        <result property="productAmount"     column="product_amount"    />
        <result property="freightAmount"     column="freight_amount"    />
        <result property="discountAmount"    column="discount_amount"   />
        <result property="pointsAmount"      column="points_amount"     />
        <result property="payAmount"         column="pay_amount"        />
        <result property="usePoints"         column="use_points"        />
        <result property="earnPoints"        column="earn_points"       />
        <result property="payType"           column="pay_type"          />
        <result property="payTime"           column="pay_time"          />
        <result property="shipTime"          column="ship_time"         />
        <result property="receiveTime"       column="receive_time"      />
        <result property="finishTime"        column="finish_time"       />
        <result property="cancelTime"        column="cancel_time"       />
        <result property="receiverName"      column="receiver_name"     />
        <result property="receiverPhone"     column="receiver_phone"    />
        <result property="receiverProvince"  column="receiver_province" />
        <result property="receiverCity"      column="receiver_city"     />
        <result property="receiverDistrict"  column="receiver_district" />
        <result property="receiverAddress"   column="receiver_address"  />
        <result property="orderRemark"       column="order_remark"      />
        <result property="cancelReason"      column="cancel_reason"     />
        <result property="createTime"        column="create_time"       />
        <result property="updateTime"        column="update_time"       />
    </resultMap>

    <resultMap type="ShopOrderItem" id="ShopOrderItemResult">
        <id     property="itemId"        column="item_id"        />
        <result property="orderId"       column="order_id"       />
        <result property="productId"     column="product_id"     />
        <result property="productName"   column="product_name"   />
        <result property="productImage"  column="product_image"  />
        <result property="productPrice"  column="product_price"  />
        <result property="quantity"      column="quantity"       />
        <result property="subtotal"      column="subtotal"       />
        <result property="createTime"    column="create_time"    />
    </resultMap>

    <sql id="selectOrderVo">
        select order_id, order_no, user_id, username, order_status, product_count, product_amount,
               freight_amount, discount_amount, points_amount, pay_amount, use_points, earn_points,
               pay_type, pay_time, ship_time, receive_time, finish_time, cancel_time,
               receiver_name, receiver_phone, receiver_province, receiver_city, receiver_district,
               receiver_address, order_remark, cancel_reason, create_time, update_time
        from shop_order
    </sql>

    <select id="selectOrderById" parameterType="Long" resultMap="ShopOrderResult">
        <include refid="selectOrderVo"/>
        where order_id = #{orderId}
    </select>

    <select id="selectOrderList" parameterType="ShopOrder" resultMap="ShopOrderResult">
        <include refid="selectOrderVo"/>
        <where>
            <if test="orderNo != null and orderNo != ''">
                AND order_no like concat('%', #{orderNo}, '%')
            </if>
            <if test="username != null and username != ''">
                AND username like concat('%', #{username}, '%')
            </if>
            <if test="orderStatus != null and orderStatus != ''">
                AND order_status = #{orderStatus}
            </if>
            <if test="payType != null and payType != ''">
                AND pay_type = #{payType}
            </if>
            <if test="receiverName != null and receiverName != ''">
                AND receiver_name like concat('%', #{receiverName}, '%')
            </if>
            <if test="receiverPhone != null and receiverPhone != ''">
                AND receiver_phone like concat('%', #{receiverPhone}, '%')
            </if>
            <if test="params.beginTime != null and params.beginTime != ''">
                AND date_format(create_time,'%Y-%m-%d') &gt;= date_format(#{params.beginTime},'%Y-%m-%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                AND date_format(create_time,'%Y-%m-%d') &lt;= date_format(#{params.endTime},'%Y-%m-%d')
            </if>
        </where>
        order by create_time desc
    </select>

    <select id="selectOrderItemsByOrderId" parameterType="Long" resultMap="ShopOrderItemResult">
        select item_id, order_id, product_id, product_name, product_image, product_price, quantity, subtotal, create_time
        from shop_order_item
        where order_id = #{orderId}
    </select>

    <insert id="insertOrder" parameterType="ShopOrder" useGeneratedKeys="true" keyProperty="orderId">
        insert into shop_order
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orderNo != null and orderNo != ''">order_no,</if>
            <if test="userId != null">user_id,</if>
            <if test="username != null">username,</if>
            <if test="orderStatus != null">order_status,</if>
            <if test="productCount != null">product_count,</if>
            <if test="productAmount != null">product_amount,</if>
            <if test="freightAmount != null">freight_amount,</if>
            <if test="discountAmount != null">discount_amount,</if>
            <if test="pointsAmount != null">points_amount,</if>
            <if test="payAmount != null">pay_amount,</if>
            <if test="usePoints != null">use_points,</if>
            <if test="earnPoints != null">earn_points,</if>
            <if test="payType != null">pay_type,</if>
            <if test="receiverName != null">receiver_name,</if>
            <if test="receiverPhone != null">receiver_phone,</if>
            <if test="receiverProvince != null">receiver_province,</if>
            <if test="receiverCity != null">receiver_city,</if>
            <if test="receiverDistrict != null">receiver_district,</if>
            <if test="receiverAddress != null">receiver_address,</if>
            <if test="orderRemark != null">order_remark,</if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="orderNo != null and orderNo != ''">#{orderNo},</if>
            <if test="userId != null">#{userId},</if>
            <if test="username != null">#{username},</if>
            <if test="orderStatus != null">#{orderStatus},</if>
            <if test="productCount != null">#{productCount},</if>
            <if test="productAmount != null">#{productAmount},</if>
            <if test="freightAmount != null">#{freightAmount},</if>
            <if test="discountAmount != null">#{discountAmount},</if>
            <if test="pointsAmount != null">#{pointsAmount},</if>
            <if test="payAmount != null">#{payAmount},</if>
            <if test="usePoints != null">#{usePoints},</if>
            <if test="earnPoints != null">#{earnPoints},</if>
            <if test="payType != null">#{payType},</if>
            <if test="receiverName != null">#{receiverName},</if>
            <if test="receiverPhone != null">#{receiverPhone},</if>
            <if test="receiverProvince != null">#{receiverProvince},</if>
            <if test="receiverCity != null">#{receiverCity},</if>
            <if test="receiverDistrict != null">#{receiverDistrict},</if>
            <if test="receiverAddress != null">#{receiverAddress},</if>
            <if test="orderRemark != null">#{orderRemark},</if>
            sysdate()
        </trim>
    </insert>

    <update id="updateOrder" parameterType="ShopOrder">
        update shop_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="orderStatus != null">order_status = #{orderStatus},</if>
            <if test="payType != null">pay_type = #{payType},</if>
            <if test="receiverName != null">receiver_name = #{receiverName},</if>
            <if test="receiverPhone != null">receiver_phone = #{receiverPhone},</if>
            <if test="receiverProvince != null">receiver_province = #{receiverProvince},</if>
            <if test="receiverCity != null">receiver_city = #{receiverCity},</if>
            <if test="receiverDistrict != null">receiver_district = #{receiverDistrict},</if>
            <if test="receiverAddress != null">receiver_address = #{receiverAddress},</if>
            <if test="orderRemark != null">order_remark = #{orderRemark},</if>
            update_time = sysdate()
        </trim>
        where order_id = #{orderId}
    </update>

    <update id="updateOrderShip" parameterType="ShopOrder">
        update shop_order set order_status = 'shipped', ship_time = sysdate(), update_time = sysdate()
        where order_id = #{orderId}
    </update>

    <update id="updateOrderCancel" parameterType="ShopOrder">
        update shop_order set order_status = 'cancelled', cancel_time = sysdate(), cancel_reason = #{cancelReason}, update_time = sysdate()
        where order_id = #{orderId}
    </update>

    <update id="updateOrderComplete" parameterType="Long">
        update shop_order set order_status = 'completed', finish_time = sysdate(), update_time = sysdate()
        where order_id = #{orderId}
    </update>

    <delete id="deleteOrderById" parameterType="Long">
        delete from shop_order where order_id = #{orderId}
    </delete>

    <delete id="deleteOrderByIds" parameterType="Long">
        delete from shop_order where order_id in
        <foreach item="orderId" collection="array" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </delete>

    <insert id="insertOrderItem" parameterType="ShopOrderItem">
        insert into shop_order_item (order_id, product_id, product_name, product_image, product_price, quantity, subtotal)
        values (#{orderId}, #{productId}, #{productName}, #{productImage}, #{productPrice}, #{quantity}, #{subtotal})
    </insert>

    <insert id="batchInsertOrderItems" parameterType="java.util.List">
        insert into shop_order_item (order_id, product_id, product_name, product_image, product_price, quantity, subtotal)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.orderId}, #{item.productId}, #{item.productName}, #{item.productImage}, #{item.productPrice}, #{item.quantity}, #{item.subtotal})
        </foreach>
    </insert>

</mapper>
