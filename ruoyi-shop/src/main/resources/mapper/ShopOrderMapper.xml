<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.shop.mapper.ShopOrderMapper">

    <resultMap type="ShopOrder" id="ShopOrderResult">
        <id     property="orderId"           column="order_id"          />
        <result property="orderNo"           column="order_no"          />
        <result property="userId"            column="user_id"           />
        <result property="username"          column="username"          />
        <result property="orderStatus"       column="order_status"      />
        <result property="productCount"      column="product_count"     />
        <result property="productAmount"     column="product_amount"    />
        <result property="freightAmount"     column="freight_amount"    />
        <result property="discountAmount"    column="discount_amount"   />
        <result property="pointsAmount"      column="points_amount"     />
        <result property="payAmount"         column="pay_amount"        />
        <result property="usePoints"         column="use_points"        />
        <result property="earnPoints"        column="earn_points"       />
        <result property="payType"           column="pay_type"          />
        <result property="payTime"           column="pay_time"          />
        <result property="shipTime"          column="ship_time"         />
        <result property="receiveTime"       column="receive_time"      />
        <result property="finishTime"        column="finish_time"       />
        <result property="cancelTime"        column="cancel_time"       />
        <result property="receiverName"      column="receiver_name"     />
        <result property="receiverPhone"     column="receiver_phone"    />
        <result property="receiverProvince"  column="receiver_province" />
        <result property="receiverCity"      column="receiver_city"     />
        <result property="receiverDistrict"  column="receiver_district" />
        <result property="receiverAddress"   column="receiver_address"  />
        <result property="orderRemark"       column="order_remark"      />
        <result property="cancelReason"      column="cancel_reason"     />
        <result property="createTime"        column="create_time"       />
        <result property="updateTime"        column="update_time"       />
    </resultMap>

    <resultMap type="ShopOrderItem" id="ShopOrderItemResult">
        <id     property="itemId"        column="item_id"        />
        <result property="orderId"       column="order_id"       />
        <result property="productId"     column="product_id"     />
        <result property="productName"   column="product_name"   />
        <result property="productImage"  column="product_image"  />
        <result property="productPrice"  column="product_price"  />
        <result property="quantity"      column="quantity"       />
        <result property="subtotal"      column="subtotal"       />
        <result property="createTime"    column="create_time"    />
    </resultMap>

    <sql id="selectOrderVo">
        select order_id, order_no, user_id, username, order_status, product_count, product_amount,
               freight_amount, discount_amount, points_amount, pay_amount, use_points, earn_points,
               pay_type, pay_time, ship_time, receive_time, finish_time, cancel_time,
               receiver_name, receiver_phone, receiver_province, receiver_city, receiver_district,
               receiver_address, order_remark, cancel_reason, create_time, update_time
        from shop_order
    </sql>

    <select id="selectOrderById" parameterType="Long" resultMap="ShopOrderResult">
        <include refid="selectOrderVo"/>
        where order_id = #{orderId}
    </select>

    <select id="selectOrderList" parameterType="ShopOrder" resultMap="ShopOrderResult">
        <include refid="selectOrderVo"/>
        <where>
            <if test="orderNo != null and orderNo != ''">
                AND order_no like concat('%', #{orderNo}, '%')
            </if>
            <if test="username != null and username != ''">
                AND username like concat('%', #{username}, '%')
            </if>
            <if test="orderStatus != null and orderStatus != ''">
                AND order_status = #{orderStatus}
            </if>
            <if test="payType != null and payType != ''">
                AND pay_type = #{payType}
            </if>
            <if test="receiverName != null and receiverName != ''">
                AND receiver_name like concat('%', #{receiverName}, '%')
            </if>
            <if test="receiverPhone != null and receiverPhone != ''">
                AND receiver_phone like concat('%', #{receiverPhone}, '%')
            </if>
            <if test="params.beginTime != null and params.beginTime != ''">
                AND date_format(create_time,'%Y-%m-%d') &gt;= date_format(#{params.beginTime},'%Y-%m-%d')
            </if>
            <if test="params.endTime != null and params.endTime != ''">
                AND date_format(create_time,'%Y-%m-%d') &lt;= date_format(#{params.endTime},'%Y-%m-%d')
            </if>
        </where>
        order by create_time desc
    </select>

    <select id="selectOrderItemsByOrderId" parameterType="Long" resultMap="ShopOrderItemResult">
        select item_id, order_id, product_id, product_name, product_image, product_price, quantity, subtotal, create_time
        from shop_order_item
        where order_id = #{orderId}
    </select>

    <insert id="insertOrder" parameterType="ShopOrder" useGeneratedKeys="true" keyProperty="orderId">
        insert into shop_order
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="orderNo != null and orderNo != ''">order_no,</if>
            <if test="userId != null">user_id,</if>
            <if test="username != null">username,</if>
            <if test="orderStatus != null">order_status,</if>
            <if test="productCount != null">product_count,</if>
            <if test="productAmount != null">product_amount,</if>
            <if test="freightAmount != null">freight_amount,</if>
            <if test="discountAmount != null">discount_amount,</if>
            <if test="pointsAmount != null">points_amount,</if>
            <if test="payAmount != null">pay_amount,</if>
            <if test="usePoints != null">use_points,</if>
            <if test="earnPoints != null">earn_points,</if>
            <if test="payType != null">pay_type,</if>
            <if test="receiverName != null">receiver_name,</if>
            <if test="receiverPhone != null">receiver_phone,</if>
            <if test="receiverProvince != null">receiver_province,</if>
            <if test="receiverCity != null">receiver_city,</if>
            <if test="receiverDistrict != null">receiver_district,</if>
            <if test="receiverAddress != null">receiver_address,</if>
            <if test="orderRemark != null">order_remark,</if>
            create_time
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="orderNo != null and orderNo != ''">#{orderNo},</if>
            <if test="userId != null">#{userId},</if>
            <if test="username != null">#{username},</if>
            <if test="orderStatus != null">#{orderStatus},</if>
            <if test="productCount != null">#{productCount},</if>
            <if test="productAmount != null">#{productAmount},</if>
            <if test="freightAmount != null">#{freightAmount},</if>
            <if test="discountAmount != null">#{discountAmount},</if>
            <if test="pointsAmount != null">#{pointsAmount},</if>
            <if test="payAmount != null">#{payAmount},</if>
            <if test="usePoints != null">#{usePoints},</if>
            <if test="earnPoints != null">#{earnPoints},</if>
            <if test="payType != null">#{payType},</if>
            <if test="receiverName != null">#{receiverName},</if>
            <if test="receiverPhone != null">#{receiverPhone},</if>
            <if test="receiverProvince != null">#{receiverProvince},</if>
            <if test="receiverCity != null">#{receiverCity},</if>
            <if test="receiverDistrict != null">#{receiverDistrict},</if>
            <if test="receiverAddress != null">#{receiverAddress},</if>
            <if test="orderRemark != null">#{orderRemark},</if>
            sysdate()
        </trim>
    </insert>

    <update id="updateOrder" parameterType="ShopOrder">
        update shop_order
        <trim prefix="SET" suffixOverrides=",">
            <if test="orderStatus != null">order_status = #{orderStatus},</if>
            <if test="payType != null">pay_type = #{payType},</if>
            <if test="receiverName != null">receiver_name = #{receiverName},</if>
            <if test="receiverPhone != null">receiver_phone = #{receiverPhone},</if>
            <if test="receiverProvince != null">receiver_province = #{receiverProvince},</if>
            <if test="receiverCity != null">receiver_city = #{receiverCity},</if>
            <if test="receiverDistrict != null">receiver_district = #{receiverDistrict},</if>
            <if test="receiverAddress != null">receiver_address = #{receiverAddress},</if>
            <if test="orderRemark != null">order_remark = #{orderRemark},</if>
            update_time = sysdate()
        </trim>
        where order_id = #{orderId}
    </update>

    <update id="updateOrderShip" parameterType="ShopOrder">
        update shop_order set order_status = 'shipped', ship_time = sysdate(), update_time = sysdate()
        where order_id = #{orderId}
    </update>

    <update id="updateOrderCancel" parameterType="ShopOrder">
        update shop_order set order_status = 'cancelled', cancel_time = sysdate(), cancel_reason = #{cancelReason}, update_time = sysdate()
        where order_id = #{orderId}
    </update>

    <update id="updateOrderComplete" parameterType="Long">
        update shop_order set order_status = 'completed', finish_time = sysdate(), update_time = sysdate()
        where order_id = #{orderId}
    </update>

    <delete id="deleteOrderById" parameterType="Long">
        delete from shop_order where order_id = #{orderId}
    </delete>

    <delete id="deleteOrderByIds" parameterType="Long">
        delete from shop_order where order_id in
        <foreach item="orderId" collection="array" open="(" separator="," close=")">
            #{orderId}
        </foreach>
    </delete>

    <insert id="insertOrderItem" parameterType="ShopOrderItem">
        insert into shop_order_item (order_id, product_id, product_name, product_image, product_price, quantity, subtotal)
        values (#{orderId}, #{productId}, #{productName}, #{productImage}, #{productPrice}, #{quantity}, #{subtotal})
    </insert>

    <insert id="batchInsertOrderItems" parameterType="java.util.List">
        insert into shop_order_item (order_id, product_id, product_name, product_image, product_price, quantity, subtotal)
        values
        <foreach collection="list" item="item" separator=",">
            (#{item.orderId}, #{item.productId}, #{item.productName}, #{item.productImage}, #{item.productPrice}, #{item.quantity}, #{item.subtotal})
        </foreach>
    </insert>

    <!-- ==================== 统计查询 ==================== -->

    <select id="selectOrderOverview" resultType="java.util.Map">
        SELECT
            COUNT(*) as total_orders,
            COALESCE(SUM(pay_amount), 0) as total_amount,
            SUM(CASE WHEN DATE(create_time) = CURDATE() THEN 1 ELSE 0 END) as today_orders,
            COALESCE(SUM(CASE WHEN DATE(create_time) = CURDATE() THEN pay_amount ELSE 0 END), 0) as today_amount,
            SUM(CASE WHEN order_status = 'pending' THEN 1 ELSE 0 END) as pending_orders,
            SUM(CASE WHEN order_status = 'paid' THEN 1 ELSE 0 END) as paid_orders,
            SUM(CASE WHEN order_status = 'shipped' THEN 1 ELSE 0 END) as shipped_orders,
            SUM(CASE WHEN order_status = 'completed' THEN 1 ELSE 0 END) as completed_orders,
            SUM(CASE WHEN order_status = 'cancelled' THEN 1 ELSE 0 END) as cancelled_orders
        FROM shop_order
    </select>

    <select id="selectOrderTrend" parameterType="java.util.Map" resultType="java.util.HashMap">
        SELECT
            DATE_FORMAT(create_time, '${dateFormat}') as date,
            COUNT(*) as order_count,
            COALESCE(SUM(pay_amount), 0) as order_amount
        FROM shop_order
        <where>
            <if test="startTime != null and startTime != ''">
                AND DATE(create_time) &gt;= #{startTime}
            </if>
            <if test="endTime != null and endTime != ''">
                AND DATE(create_time) &lt;= #{endTime}
            </if>
        </where>
        GROUP BY DATE_FORMAT(create_time, '${dateFormat}')
        ORDER BY date ASC
    </select>

    <select id="selectOrderStatusStatistics" resultType="java.util.HashMap">
        SELECT
            order_status as status,
            CASE order_status
                WHEN 'pending' THEN '待付款'
                WHEN 'paid' THEN '已付款'
                WHEN 'shipped' THEN '已发货'
                WHEN 'completed' THEN '已完成'
                WHEN 'cancelled' THEN '已取消'
                ELSE '未知'
            END as status_name,
            COUNT(*) as count
        FROM shop_order
        GROUP BY order_status
        ORDER BY count DESC
    </select>

    <select id="selectTopSellingProducts" parameterType="java.lang.Integer" resultType="java.util.HashMap">
        SELECT
            oi.product_id as product_id,
            oi.product_name as product_name,
            oi.product_image as product_image,
            SUM(oi.quantity) as sales_count,
            COALESCE(SUM(oi.subtotal), 0) as sales_amount
        FROM shop_order_item oi
        INNER JOIN shop_order o ON oi.order_id = o.order_id
        WHERE o.order_status IN ('paid', 'shipped', 'completed')
        GROUP BY oi.product_id, oi.product_name, oi.product_image
        ORDER BY sales_count DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

</mapper>
